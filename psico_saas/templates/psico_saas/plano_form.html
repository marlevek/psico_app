{% extends 'psico_saas/base.html' %}
{% load static %}

{% block title %}{% if plano %}Editar Plano{% else %}Novo Plano{% endif %} - Psico SaaS{% endblock %}

{% block content %}
<div class="page-header fade-in">
    <div class="header-content">
        <div>
            <h1>{% if plano %}‚úèÔ∏è Editar Plano{% else %}üìã Criar Novo Plano{% endif %}</h1>
            <p class="text-muted">{% if plano %}Atualize as informa√ß√µes do plano de tratamento{% else %}Preencha os dados para criar um novo plano terap√™utico{% endif %}</p>
        </div>
        <a href="{% url 'listar_planos' %}" class="btn btn-outline">
            <i class="bi bi-arrow-left"></i>
            Voltar para Lista
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card fade-in">
            <div class="card-header">
                <h3 class="mb-0">Informa√ß√µes do Plano</h3>
            </div>
            <div class="card-body">
                {% if error_message and not form_errors %}
                    <div class="alert alert-error">
                        <i class="bi bi-exclamation-triangle"></i>
                        {{ error_message }}
                    </div>
                {% endif %}

                {% if form_errors %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-circle"></i>
                        <strong>Erro de valida√ß√£o.</strong> Por favor, verifique os campos em vermelho abaixo.
                    </div>
                {% endif %}

                <form method="post" novalidate class="plano-form">
                    {% csrf_token %}

                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="form-section">
                        <h4 class="section-title">üìù Informa√ß√µes B√°sicas</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paciente" class="form-label required">Paciente</label>
                                <select id="paciente" name="paciente" 
                                        class="form-control form-select {% if form_errors.paciente %}is-invalid{% endif %}" 
                                        required>
                                    <option value="">Selecione um paciente...</option>
                                    {% for paciente in pacientes %}
                                        <option value="{{ paciente.pk }}" 
                                            {% if request_post.paciente == paciente.pk|stringformat:"i" or plano.paciente.pk == paciente.pk %}selected{% endif %}>
                                            {{ paciente.nome_completo }} ({{ paciente.get_idade }} anos)
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if form_errors.paciente %}
                                    <div class="invalid-feedback">
                                        {% for error in form_errors.paciente %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="data_inicio_prevista" class="form-label required">Data de In√≠cio Prevista</label>
                                <input type="date" id="data_inicio_prevista" name="data_inicio_prevista" 
                                       class="form-control {% if form_errors.data_inicio_prevista %}is-invalid{% endif %}" 
                                       value="{% if request_post.data_inicio_prevista %}{{ request_post.data_inicio_prevista }}{% elif plano %}{{ plano.data_inicio_prevista|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}" 
                                       required>
                                {% if form_errors.data_inicio_prevista %}
                                    <div class="invalid-feedback">
                                        {% for error in form_errors.data_inicio_prevista %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="titulo" class="form-label required">T√≠tulo do Plano</label>
                            <input type="text" id="titulo" name="titulo" 
                                   class="form-control {% if form_errors.titulo %}is-invalid{% endif %}" 
                                   value="{% if request_post.titulo %}{{ request_post.titulo }}{% elif plano %}{{ plano.titulo }}{% endif %}" 
                                   placeholder="Ex: Plano para Ansiedade Generalizada"
                                   required>
                            {% if form_errors.titulo %}
                                <div class="invalid-feedback">
                                    {% for error in form_errors.titulo %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="abordagem" class="form-label required">Abordagem Terap√™utica</label>
                            <textarea id="abordagem" name="abordagem" rows="2" 
                                      class="form-control {% if form_errors.abordagem %}is-invalid{% endif %}" 
                                      placeholder="Descreva a abordagem principal que ser√° utilizada..."
                                      required>{% if request_post.abordagem %}{{ request_post.abordagem }}{% elif plano %}{{ plano.abordagem }}{% endif %}</textarea>
                            {% if form_errors.abordagem %}
                                <div class="invalid-feedback">
                                    {% for error in form_errors.abordagem %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Diagn√≥stico e Metas -->
                    <div class="form-section">
                        <h4 class="section-title">üéØ Diagn√≥stico e Metas</h4>
                        
                        <div class="form-group">
                            <label for="diagnostico_base" class="form-label required">Diagn√≥stico Base / Hip√≥tese</label>
                            <textarea id="diagnostico_base" name="diagnostico_base" rows="4" 
                                      class="form-control {% if form_errors.diagnostico_base %}is-invalid{% endif %}" 
                                      placeholder="Descreva o diagn√≥stico principal, hip√≥teses e observa√ß√µes iniciais..."
                                      required>{% if request_post.diagnostico_base %}{{ request_post.diagnostico_base }}{% elif plano %}{{ plano.diagnostico_base }}{% endif %}</textarea>
                            {% if form_errors.diagnostico_base %}
                                <div class="invalid-feedback">
                                    {% for error in form_errors.diagnostico_base %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="metas_tratamento" class="form-label required">Metas de Tratamento</label>
                            <textarea id="metas_tratamento" name="metas_tratamento" rows="6" 
                                      class="form-control {% if form_errors.metas_tratamento %}is-invalid{% endif %}" 
                                      placeholder="Descreva as metas de longo e curto prazo, objetivos espec√≠ficos e indicadores de progresso..."
                                      required>{% if request_post.metas_tratamento %}{{ request_post.metas_tratamento }}{% elif plano %}{{ plano.metas_tratamento }}{% endif %}</textarea>
                            {% if form_errors.metas_tratamento %}
                                <div class="invalid-feedback">
                                    {% for error in form_errors.metas_tratamento %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text">Inclua metas mensur√°veis e prazos realistas</small>
                        </div>
                    </div>

                    <!-- Configura√ß√µes das Sess√µes -->
                    <div class="form-section">
                        <h4 class="section-title">üïí Configura√ß√£o das Sess√µes</h4>
                        
                        <div class="form-group">
                            <label for="frequencia_sessoes" class="form-label required">Frequ√™ncia das Sess√µes</label>
                            <input type="text" id="frequencia_sessoes" name="frequencia_sessoes" 
                                   class="form-control {% if form_errors.frequencia_sessoes %}is-invalid{% endif %}" 
                                   value="{% if request_post.frequencia_sessoes %}{{ request_post.frequencia_sessoes }}{% elif plano %}{{ plano.frequencia_sessoes }}{% else %}Semanalmente{% endif %}" 
                                   placeholder="Ex: Semanalmente, Quinzenalmente, Mensalmente"
                                   required>
                            {% if form_errors.frequencia_sessoes %}
                                <div class="invalid-feedback">
                                    {% for error in form_errors.frequencia_sessoes %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Bot√£o de Submiss√£o -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-lg">
                            {% if plano %}
                                <i class="bi bi-check-circle"></i>
                                Atualizar Plano
                            {% else %}
                                <i class="bi bi-stars"></i>
                                Criar Plano com IA
                            {% endif %}
                        </button>
                        
                        <a href="{% url 'listar_planos' %}" class="btn btn-outline">
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar de Ajuda -->
    <div class="col-lg-4">
        <div class="card fade-in">
            <div class="card-header">
                <h4 class="mb-0">üí° Dicas para um Bom Plano</h4>
            </div>
            <div class="card-body">
                <div class="tip-item">
                    <h5>üéØ Seja Espec√≠fico</h5>
                    <p>Metas claras e mensur√°veis facilitam o acompanhamento do progresso.</p>
                </div>
                <div class="tip-item">
                    <h5>‚è±Ô∏è Realista no Tempo</h5>
                    <p>Estabele√ßa prazos alcan√ß√°veis considerando a complexidade do caso.</p>
                </div>
                <div class="tip-item">
                    <h5>üîÑ Flex√≠vel</h5>
                    <p>O plano pode e deve ser ajustado conforme a evolu√ß√£o do paciente.</p>
                </div>
                <div class="tip-item">
                    <h5>ü§ñ IA como Aliada</h5>
                    <p>Nossa IA ir√° revisar e sugerir melhorias no seu plano automaticamente.</p>
                </div>
            </div>
        </div>

        <!-- Preview do Paciente -->
        {% if plano and plano.paciente %}
        <div class="card fade-in mt-4">
            <div class="card-header">
                <h4 class="mb-0">üë§ Informa√ß√µes do Paciente</h4>
            </div>
            <div class="card-body">
                <div class="patient-preview">
                    <h5>{{ plano.paciente.nome_completo }}</h5>
                    <p><strong>Idade:</strong> {{ plano.paciente.get_idade }} anos</p>
                    <p><strong>Contato:</strong> {{ plano.paciente.telefone|default:"N√£o informado" }}</p>
                    <p><strong>Email:</strong> {{ plano.paciente.email|default:"N√£o informado" }}</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Feedback da IA -->
{% if feedback_ia %}
<div class="card fade-in mt-4">
    <div class="card-header">
        <h3 class="mb-0">ü§ñ Feedback da Intelig√™ncia Artificial</h3>
    </div>
    <div class="card-body">
        <div class="feedback-ia">
            {{ feedback_ia|linebreaks }}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}