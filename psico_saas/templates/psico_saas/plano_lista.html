{% extends 'psico_saas/base.html' %}
{% load static %}

{% block title %}Planos de Tratamento - Psico SaaS{% endblock %}

{% block content %}
<div class="page-header fade-in">
    <div class="header-content">
        <div>
            <h1>ðŸ“‹ Planos de Tratamento</h1>
            <p class="text-muted">Gerencie todos os planos terapÃªuticos dos seus pacientes</p>
        </div>
        <a href="{% url 'plano_form' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i>
            Novo Plano
        </a>
    </div>
</div>

<!-- Filtros e Busca -->
<div class="card fade-in mb-4">
    <div class="filter-section">
        <div class="row g-3">
            <div class="col-md-6">
                <input type="text" class="form-control" placeholder="ðŸ” Buscar por paciente ou tÃ­tulo..." id="searchInput">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">Todos os status</option>
                    <option value="ativo">Ativos</option>
                    <option value="concluido">ConcluÃ­dos</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline w-100" onclick="clearFilters()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Limpar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Planos -->
<div class="card fade-in">
    <div class="card-header">
        <h3 class="mb-0">Meus Planos ({{ planos|length }})</h3>
    </div>
    
    {% if planos %}
    <!-- VersÃ£o Desktop - Tabela (apenas desktop) -->
    <div class="d-none d-lg-block">
        <div class="table-responsive">
            <table class="table" id="planosTable">
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>TÃ­tulo do Plano</th>
                        <th>Data de InÃ­cio</th>
                        <th>Status</th>
                        <th>Ãšltima AtualizaÃ§Ã£o</th>
                        <th>AÃ§Ãµes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plano in planos %}
                    <tr class="plano-row">
                        <td>
                            <div class="patient-info">
                                <strong>{{ plano.paciente.nome_completo }}</strong>
                                <small class="text-muted">Idade: {{ plano.paciente.get_idade }} anos</small>
                            </div>
                        </td>
                        <td>
                            <strong>{{ plano.titulo }}</strong>
                            <br>
                            <small class="text-muted">{{ plano.abordagem|truncatewords:5 }}</small>
                        </td>
                        <td>
                            {{ plano.data_inicio_prevista|date:"d/m/Y" }}
                        </td>
                        <td>
                            <span class="status-badge status-active">
                                <i class="bi bi-circle-fill"></i>
                                Ativo
                            </span>
                        </td>
                        <td>
                            {{ plano.data_atualizacao|date:"d/m/Y" }}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="{% url 'editar_plano' plano.id %}" class="btn btn-sm btn-outline" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="#" class="btn btn-sm btn-outline" title="Ver Detalhes">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <form method="post" action="{% url 'excluir_plano' plano.id %}" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir este plano?')">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline text-danger" title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- VersÃ£o Mobile - Cards (tablet e mobile) -->
    <div class="d-lg-none" id="planosCards">
        {% for plano in planos %}
        <div class="plano-card" data-search="{{ plano.paciente.nome_completo }} {{ plano.titulo }} {{ plano.abordagem }}">
            <div class="card-header-mobile">
                <div class="patient-mobile">
                    <strong>{{ plano.paciente.nome_completo }}</strong>
                    <span class="age-mobile">{{ plano.paciente.get_idade }} anos</span>
                </div>
                <span class="status-badge status-active">
                    <i class="bi bi-circle-fill"></i>
                    Ativo
                </span>
            </div>
            
            <div class="card-body-mobile">
                <h4>{{ plano.titulo }}</h4>
                <p class="abordagem-mobile">{{ plano.abordagem|truncatewords:8 }}</p>
                
                <div class="plano-info-mobile">
                    <div class="info-item">
                        <i class="bi bi-calendar3"></i>
                        <span>InÃ­cio: {{ plano.data_inicio_prevista|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span>Atualizado: {{ plano.data_atualizacao|date:"d/m/Y" }}</span>
                    </div>
                </div>
                
                <div class="action-buttons-mobile">
                    <a href="{% url 'editar_plano' plano.id %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-pencil"></i>
                        Editar
                    </a>
                    <a href="#" class="btn btn-sm btn-outline">
                        <i class="bi bi-eye"></i>
                        Ver
                    </a>
                    <form method="post" action="{% url 'excluir_plano' plano.id %}" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir este plano?')">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline text-danger">
                            <i class="bi bi-trash"></i>
                            Excluir
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ðŸ“‹</div>
        <h3>Nenhum plano criado ainda</h3>
        <p class="text-muted">Comece criando seu primeiro plano de tratamento para um paciente.</p>
        <a href="{% url 'plano_form' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i>
            Criar Primeiro Plano
        </a>
    </div>
    {% endif %}
</div>

<!-- EstatÃ­sticas RÃ¡pidas -->
<div class="dashboard-grid mt-4">
    <div class="card stats-card">
        <div class="stats-number">{{ planos|length }}</div>
        <div class="stats-label">Total de Planos</div>
    </div>
    <div class="card stats-card">
        <div class="stats-number">{{ planos|length }}</div>
        <div class="stats-label">Planos Ativos</div>
    </div>
    <div class="card stats-card">
        <div class="stats-number">0</div>
        <div class="stats-label">ConcluÃ­dos</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Filtro e busca em tempo real - FUNCIONANDO PARA AMBAS AS VERSÃ•ES
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    // Filtra tabela desktop
    const rows = document.querySelectorAll('#planosTable .plano-row');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
    
    // Filtra cards mobile
    const cards = document.querySelectorAll('#planosCards .plano-card');
    cards.forEach(card => {
        const searchData = card.getAttribute('data-search').toLowerCase();
        card.style.display = searchData.includes(searchTerm) ? '' : 'none';
    });
});

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    
    // Mostra todos os itens
    const rows = document.querySelectorAll('#planosTable .plano-row');
    rows.forEach(row => row.style.display = '');
    
    const cards = document.querySelectorAll('#planosCards .plano-card');
    cards.forEach(card => card.style.display = '');
}
</script>
{% endblock %}